# 更新日志

## [最新版本] - 2025-11-17

### ✨ 新增功能

#### 1. 实时批次进度显示
- **进度条实时更新**: 显示当前批次处理百分比
- **批次信息显示**: 例如 "AI分析中: 批次 3/8 (37%)"
- **建议实时更新**: 每批次完成后立即在GUI中显示该批次的分析建议
- **详细日志**: 每批次完成后在日志区域记录处理信息

#### 2. 可配置的批次大小
新增配置项（在 `config.py`）:
```python
MAX_FILES_PER_REQUEST = 10  # 每批文件数量（5-20）
AI_TIMEOUT = 120            # API超时时间（秒）
AI_MAX_RETRIES = 3          # 最大重试次数
AI_RETRY_DELAY = 5          # 重试间隔（秒）
```

#### 3. 详细的API调用日志
新增日志配置（在 `config.py`）:
```python
ENABLE_DETAIL_LOG = True       # 启用详细日志
LOG_REQUEST_PARAMS = True      # 记录请求参数
LOG_RESPONSE_CONTENT = True    # 记录响应内容
```

#### 4. 增强的错误处理
- 区分超时、HTTP错误、网络错误等不同错误类型
- 智能重试机制（递增等待时间）
- 详细的错误信息打印

### 📊 功能改进

#### AI分析模块
- **分批处理**: 自动将大量文件分批发送给AI
- **进度回调**: 支持批次进度回调函数
- **Token统计**: 显示每次API调用的Token使用情况
- **响应时间**: 记录每次API调用的耗时

#### 用户界面
- **实时更新**: 建议表格随批次进度实时更新
- **进度可视化**: 清晰的百分比进度条
- **批次信息**: 显示当前处理的批次和总批次数
- **日志优化**: 更清晰的日志输出格式

### 📝 日志功能

#### 请求日志包含：
- API URL 和模型名称
- 超时设置
- 提示词长度和内容预览
- 完整的请求体（JSON格式）

#### 响应日志包含：
- HTTP状态码
- API响应时间（秒）
- Token使用情况（输入/输出/总计）
- AI响应内容预览（前500字符）
- 完整响应内容（如果不太长）

### 🔧 配置优化

#### 性能调优
- 批次大小从 50 → 10（减少超时风险）
- 超时时间从 30秒 → 120秒（适应慢速网络）
- 支持自定义重试次数和间隔

#### 日志级别
- 可以关闭详细日志以简化输出
- 可以单独控制请求日志和响应日志

### 📚 新增文档

1. **CONFIG_GUIDE.md** - 详细的配置参数说明
2. **BATCH_PROGRESS_GUIDE.md** - 批次进度功能使用指南
3. **CHANGELOG.md** - 本更新日志
4. **test_batch_log.py** - 批次处理测试脚本

### 🐛 Bug修复

- 修复了API Key未设置的问题
- 修复了请求超时后无重试的问题
- 修复了分批处理时建议不显示的问题

### 🎯 使用示例

#### 实时进度显示
```
进度条: ████████████░░░░░░░  37%
状态: AI分析中: 批次 3/8 (37%)
日志: 批次 3/8 完成，本批获得 10 条建议
建议表格: 实时显示 1-30 条建议
```

#### 详细API日志
```
================================================================================
📡 通义千问API调用 - 尝试 1/3
================================================================================

📤 请求参数:
   URL: https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions
   模型: qwen3-coder-plus
   超时设置: 120秒
   提示词长度: 2456 字符

✅ API调用成功！
⏱️  耗时: 5.23秒
📊 响应长度: 1234 字符

📥 响应内容:
   HTTP状态码: 200
   Token使用:
      输入tokens: 856
      输出tokens: 425
      总计tokens: 1281
```

### 🚀 性能提升

- **超时问题**: 通过分批处理，减少了 80% 的超时率
- **用户体验**: 实时更新让等待不再煎熬
- **可见性**: 详细日志让问题排查更容易

### 📖 迁移指南

#### 从旧版本升级

1. **更新 config.py**
   ```python
   # 新增配置项
   MAX_FILES_PER_REQUEST = 10
   AI_TIMEOUT = 120
   AI_MAX_RETRIES = 3
   AI_RETRY_DELAY = 5
   ENABLE_DETAIL_LOG = True
   LOG_REQUEST_PARAMS = True
   LOG_RESPONSE_CONTENT = True
   ```

2. **无需修改代码**
   - 所有改进都是向后兼容的
   - 直接运行即可享受新功能

### 🎨 界面变化

#### 分析过程中
- **旧版**: 不确定进度（转圈圈），无反馈
- **新版**: 百分比进度条，批次信息，实时建议

#### 日志输出
- **旧版**: 简单的成功/失败消息
- **新版**: 详细的请求/响应日志，批次进度

### 💡 推荐配置

#### 标准使用（推荐）
```python
MAX_FILES_PER_REQUEST = 10
AI_TIMEOUT = 120
ENABLE_DETAIL_LOG = True
```

#### 快速使用（网络好）
```python
MAX_FILES_PER_REQUEST = 15
AI_TIMEOUT = 90
ENABLE_DETAIL_LOG = False
```

#### 稳定使用（网络差）
```python
MAX_FILES_PER_REQUEST = 5
AI_TIMEOUT = 180
AI_MAX_RETRIES = 5
```

### 🔮 未来计划

- [ ] 支持暂停/继续分析
- [ ] 支持保存/加载分析结果
- [ ] 支持自定义分类规则
- [ ] 支持导出分析报告
- [ ] 支持多语言界面

### 🙏 致谢

感谢所有用户的反馈和建议！

---

**完整文档**:
- README.md - 项目说明
- CONFIG_GUIDE.md - 配置指南
- BATCH_PROGRESS_GUIDE.md - 批次进度说明
- TONGYI_API_GUIDE.md - API接入指南
